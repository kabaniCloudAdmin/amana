<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Level Monitor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f5f5f5; }
        .transition-all-300 { transition: all 0.3s ease-in-out; }
        .btn-ripple:active { transform: scale(0.98); opacity: 0.8; }
        #alert-dialog { background-color: rgba(0, 0, 0, 0.5); }
        
        /* Pulse animation for the test button if audio is locked */
        @keyframes pulse-orange {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        .animate-pulse-attention {
            animation: pulse-orange 2s infinite;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-sm rounded-xl shadow-lg overflow-hidden border border-gray-100 relative">
        
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h1 class="text-lg font-medium text-gray-700 tracking-wide">Water Monitor</h1>
            
            <div class="flex items-center space-x-3">
                <button id="btn-test-sound" class="text-gray-400 hover:text-red-600 focus:outline-none transition-colors" title="Test Siren">
                    <span class="material-icons text-xl">volume_up</span>
                </button>

                <div id="connection-chip" class="flex items-center space-x-1 px-2 py-1 rounded-full bg-gray-200 text-gray-600 text-xs font-bold uppercase transition-colors duration-300">
                    <span class="material-icons text-sm" id="conn-icon">wifi_off</span>
                    <span id="conn-text">Offline</span>
                </div>
            </div>
        </div>

        <div class="p-6 flex flex-col items-center space-y-6">
            
            <div class="text-center w-full">
                <div class="text-gray-500 text-sm font-medium uppercase tracking-wider mb-1">Current Level</div>
                <div class="flex items-baseline justify-center text-gray-800">
                    <span id="water-level" class="text-7xl font-light tracking-tighter">--</span>
                    <span class="text-xl text-gray-400 ml-1">cm</span>
                </div>
            </div>

            <div class="w-full h-px bg-gray-200"></div>

            <div class="w-full grid grid-cols-2 gap-4">
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-400 font-bold uppercase">Threshold</span>
                    <span id="threshold-level" class="text-xl font-medium text-gray-600">--</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-xs text-gray-400 font-bold uppercase">Status</span>
                    <span id="status-chip" class="mt-1 px-3 py-0.5 rounded-full text-sm font-bold bg-gray-200 text-gray-500 transition-colors duration-300">
                        WAITING
                    </span>
                </div>
            </div>

            <button id="btn-enable-sound" class="hidden w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-2 px-4 rounded shadow-md flex items-center justify-center space-x-2 btn-ripple transition-all-300 animate-pulse-attention">
                <span class="material-icons">touch_app</span>
                <span>Tap to Enable Alarm</span>
            </button>
        </div>
        
        <div id="activity-bar" class="h-1 bg-blue-500 w-0 transition-all duration-300"></div>
    </div>

    <div id="alert-dialog" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center p-4 sm:p-0 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white w-full max-w-xs rounded-lg shadow-2xl overflow-hidden transform transition-transform duration-300 scale-95 sm:scale-100">
            <div class="p-4 flex items-start space-x-4">
                <div class="flex-shrink-0">
                    <span class="material-icons text-red-600 text-4xl">notifications_active</span>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-medium text-gray-900">High Water Level!</h3>
                    <p class="mt-1 text-sm text-gray-500">
                        Level exceeds threshold. Check system immediately.
                    </p>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 flex flex-row-reverse">
                <button id="btn-dismiss" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm btn-ripple">
                    DISMISS (Snooze 60s)
                </button>
            </div>
        </div>
    </div>

    <script>
        /** --- STATE --- */
        const state = {
            snoozeUntil: 0,
            isPopupVisible: false,
            audioContext: null,
            audioUnlocked: false
        };

        const DOM = {
            level: document.getElementById('water-level'),
            threshold: document.getElementById('threshold-level'),
            statusChip: document.getElementById('status-chip'),
            connChip: document.getElementById('connection-chip'),
            connText: document.getElementById('conn-text'),
            connIcon: document.getElementById('conn-icon'),
            btnEnableSound: document.getElementById('btn-enable-sound'),
            btnTestSound: document.getElementById('btn-test-sound'),
            alertDialog: document.getElementById('alert-dialog'),
            btnDismiss: document.getElementById('btn-dismiss'),
            activityBar: document.getElementById('activity-bar')
        };

        /** --- AUDIO SYSTEM (Industrial Siren Synthesis) --- */
        
        function initAudio() {
            if (!state.audioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    state.audioContext = new AudioContext();
                }
            }
            checkAudioState();
        }

        function checkAudioState() {
            if (!state.audioContext) return;
            
            if (state.audioContext.state === 'suspended') {
                state.audioUnlocked = false;
                DOM.btnEnableSound.classList.remove('hidden');
                DOM.btnTestSound.classList.add('text-amber-500', 'animate-pulse');
            } else {
                state.audioUnlocked = true;
                DOM.btnEnableSound.classList.add('hidden');
                DOM.btnTestSound.classList.remove('text-amber-500', 'animate-pulse');
                DOM.btnTestSound.classList.add('text-gray-400');
            }
        }

        async function unlockAudio() {
            if (!state.audioContext) initAudio();
            if (state.audioContext.state === 'suspended') {
                await state.audioContext.resume();
            }
            // Silent ping to wake up the audio thread
            const osc = state.audioContext.createOscillator();
            const gain = state.audioContext.createGain();
            gain.gain.value = 0.001;
            osc.connect(gain);
            gain.connect(state.audioContext.destination);
            osc.start();
            osc.stop(state.audioContext.currentTime + 0.01);
            
            checkAudioState();
        }

        // --- THE SIREN GENERATOR ---
        function playSiren() {
            if (!state.audioContext) initAudio();
            if (state.audioContext.state === 'suspended') {
                DOM.btnEnableSound.classList.remove('hidden');
                return;
            }

            const ctx = state.audioContext;
            const now = ctx.currentTime;
            const duration = 1.5; // Seconds

            // 1. The Main Tone (Sawtooth for "buzz" feeling)
            const osc = ctx.createOscillator();
            osc.type = 'sawtooth';

            // 2. The Modulator (LFO) - creates the "Wee-Woo"
            const lfo = ctx.createOscillator();
            lfo.type = 'sine';
            lfo.frequency.value = 4; // 4 cycles per second (speed of siren)

            // 3. LFO Gain - determines how wide the pitch swing is
            const lfoGain = ctx.createGain();
            lfoGain.gain.value = 300; // +/- 300Hz swing

            // 4. Master Volume for this sound
            const masterGain = ctx.createGain();
            masterGain.gain.setValueAtTime(0.2, now); // Start volume
            masterGain.gain.linearRampToValueAtTime(0.2, now + duration - 0.2);
            masterGain.gain.linearRampToValueAtTime(0.001, now + duration); // Fade out

            // CONNECTIONS:
            // LFO -> LFO Gain -> Main Oscillator Frequency
            lfo.connect(lfoGain);
            lfoGain.connect(osc.frequency);

            // Main Oscillator -> Master Gain -> Speakers
            osc.connect(masterGain);
            masterGain.connect(ctx.destination);

            // SETTINGS:
            osc.frequency.value = 900; // Center frequency (High pitched alarm)

            // START
            lfo.start(now);
            osc.start(now);

            // STOP
            lfo.stop(now + duration);
            osc.stop(now + duration);
        }

        // Manual Test
        DOM.btnTestSound.addEventListener('click', () => {
            unlockAudio().then(() => {
                playSiren();
                DOM.btnTestSound.classList.add('text-red-600');
                setTimeout(() => DOM.btnTestSound.classList.remove('text-red-600'), 1500);
            });
        });

        DOM.btnEnableSound.addEventListener('click', () => {
            unlockAudio().then(playSiren);
        });

        initAudio();


        /** --- MQTT LOGIC --- */
        const isSecure = window.location.protocol === 'https:';
        const mqttPort = isSecure ? 8081 : 8080;
        const mqttProtocol = isSecure ? 'wss' : 'ws';
        const mqttUrl = `${mqttProtocol}://test.mosquitto.org:${mqttPort}/mqtt`;

        // const client = mqtt.connect(mqttUrl, { keepalive: 60, reconnectPeriod: 2000 });

        const client = mqtt.connect("wss://test.mosquitto.org:8080/mqtt", {
        protocol: "wss",
        keepalive: 60,
        reconnectPeriod: 2000,
        connectTimeout: 10000,
        clean: true,
        protocolVersion: 4, // MQTT 3.1.1
        });
        
        const TOPIC = 'amana/water_level';

        function setConnectionStatus(status) {
            const config = {
                'Connected':    ['bg-green-100', 'text-green-700', 'wifi'],
                'Reconnecting': ['bg-yellow-100', 'text-yellow-700', 'wifi_protected_setup'],
                'Offline':      ['bg-gray-200', 'text-gray-600', 'wifi_off'],
                'Error':        ['bg-red-100', 'text-red-700', 'error_outline']
            };
            const [bg, text, icon] = config[status] || config['Offline'];
            
            DOM.connChip.className = `flex items-center space-x-1 px-2 py-1 rounded-full text-xs font-bold uppercase transition-colors duration-300 ${bg} ${text}`;
            DOM.connText.innerText = status;
            DOM.connIcon.innerText = icon;
        }

        client.on('connect', () => {
            setConnectionStatus('Connected');
            client.subscribe(TOPIC);
        });
        client.on('reconnect', () => setConnectionStatus('Reconnecting'));
        client.on('offline', () => setConnectionStatus('Offline'));
        client.on('error', (err) => { console.error(err); setConnectionStatus('Error'); });

        /** --- UI LOGIC --- */
        function updateUI(payload) {
            DOM.activityBar.style.width = '100%';
            setTimeout(() => DOM.activityBar.style.width = '0', 200);

            DOM.level.innerText = payload.currentWaterLevel;
            DOM.threshold.innerText = payload.ThresholdWaterLevel;

            if (payload.alertOn) {
                DOM.statusChip.innerText = "ALERT";
                DOM.statusChip.className = "mt-1 px-3 py-0.5 rounded-full text-sm font-bold bg-red-600 text-white shadow-sm transition-colors duration-300";
            } else {
                DOM.statusChip.innerText = "OK";
                DOM.statusChip.className = "mt-1 px-3 py-0.5 rounded-full text-sm font-bold bg-green-100 text-green-700 transition-colors duration-300";
            }
        }

        function toggleDialog(show) {
            if (show) {
                DOM.alertDialog.classList.remove('hidden');
                requestAnimationFrame(() => DOM.alertDialog.classList.remove('opacity-0'));
                state.isPopupVisible = true;
            } else {
                DOM.alertDialog.classList.add('opacity-0');
                setTimeout(() => DOM.alertDialog.classList.add('hidden'), 300);
                state.isPopupVisible = false;
            }
        }

        DOM.btnDismiss.addEventListener('click', () => {
            if (state.isPopupVisible) {
                toggleDialog(false);
                state.snoozeUntil = Date.now() + 60000;
                unlockAudio(); 
            }
        });

        client.on('message', (topic, message) => {
            try {
                const payload = JSON.parse(message.toString());
                const valid = 
                    typeof payload.currentWaterLevel === 'number' &&
                    typeof payload.ThresholdWaterLevel === 'number' &&
                    typeof payload.alertOn === 'boolean';

                if (!valid) return;

                updateUI(payload);

                const now = Date.now();

                if (payload.alertOn === false) {
                    state.snoozeUntil = 0;
                    if (state.isPopupVisible) toggleDialog(false);
                } else {
                    if (now < state.snoozeUntil) return; 

                    if (!state.isPopupVisible) {
                        toggleDialog(true);
                        playSiren();
                    }
                }
            } catch (e) { console.error(e); }
        });
    </script>
</body>
</html>
